# 系統無法正常啟動 — 根因說明

## 一句話結論

**根本原因在「環境／Windows 安全策略」**，不是專案程式碼寫錯。  
專案已配合做繞道與防呆（Rollup 用 WASM、bat 編碼與編號修正），但若電腦有 Application Control / Device Guard，**阻擋仍可能發生**，需由 IT 放行或改到不受限路徑。

---

## 因果鏈：從哪裡開始壞掉

```
① Windows 安全策略（起點）
       ↓
② 原生執行檔／原生模組被擋
       ↓
③ 前端 Rollup、後端 uvicorn 無法載入 → 啟動失敗
       ↓
④ 若用錯 Python/Node 版本或 bat 編碼，再疊加錯誤
```

---

## ① 起點：Windows 安全策略

| 可能名稱 | 作用 | 影響 |
|----------|------|------|
| **Application Control** / **WDAC** | 只允許白名單內的程式執行 | 未簽名或未放行的 `.exe`、`.node` 被擋 |
| **Device Guard** / **Credential Guard** | 依策略限制執行 | 同上，或阻擋腳本啟動的程式 |

**發生位置**：您的電腦／公司網域原則，不是專案目錄裡的某個檔案。  
**結果**：某些「從專案目錄跑出來的執行檔」被視為不信任，直接阻擋。

---

## ② 被擋的程式（導致啟動失敗的直接原因）

### 前端

| 項目 | 說明 |
|------|------|
| **@rollup/rollup-win32-x64-msvc** | Vite 依賴 Rollup，Rollup 會裝 Windows 原生 `.node` 二進位。若被 Application Control 擋住，就會出現 `Cannot find module @rollup/rollup-win32-x64-msvc`，前端 dev/build 失敗。 |
| **觸發時機** | 執行 `npm run dev` 或 `npm install` 時載入該模組。 |

### 後端

| 項目 | 說明 |
|------|------|
| **uvicorn.exe** | 放在 `backend\.venv\Scripts\uvicorn.exe`。若被策略擋住，用「直接執行 uvicorn」的方式就會失敗。 |
| **觸發時機** | 執行後端啟動腳本、一鍵啟動時。 |

所以：**「系統壞掉、無法正常啟動」的直接觸發點**，是這些執行檔／原生模組在您這台電腦上被策略擋掉。

---

## ③ 專案已做的繞道（不用改策略也能試）

| 問題 | 專案怎麼應對 |
|------|----------------|
| Rollup 原生模組被擋 | 使用 `ROLLUP_SKIP_NATIVE=1`，讓 Rollup 用純 JS/WASM 路徑；`package.json` 的 dev/build 已加上。 |
| uvicorn.exe 被擋 | 改用 `python.exe -m uvicorn` 啟動（由 `recreate_venv_py312.bat` / 一鍵啟動呼叫），不直接執行 uvicorn.exe。 |
| Node 24 相容性 | 一鍵啟動會偵測 Node 24 並提示改用 Node 20/22 LTS。 |
| Python 3.14 與 Pydantic 衝突 | 後端強制用 Python 3.12 建 venv（`recreate_venv_py312.bat`）。 |
| bat 出現「'1.' is not recognized」等 | 編號改為 [1][2][3]、開頭加 `chcp 65001`、避免 URL/冒號在 echo 裡造成解析錯誤。 |

這些都是「在策略不變的前提下」能做的修復與防呆。

---

## ④ 若仍無法啟動，該從哪邊著手

1. **確認是否為「阻擋」**  
   看錯誤是否為：  
   - 前端：`Cannot find module @rollup/rollup-win32-x64-msvc` 或與 Application Control / 無法載入二進位相關。  
   - 後端：執行 uvicorn 時權限/阻擋相關訊息。

2. **前端**  
   - 先執行：`frontend\scripts\windows\reinstall_frontend.bat`（刪 node_modules + lock、cache clean、重裝、再 dev）。  
   - 確認已用 Node 20 或 22 LTS，且一鍵啟動時有帶到 `ROLLUP_SKIP_NATIVE=1`（腳本已設）。

3. **後端**  
   - 用 `backend\scripts\windows\recreate_venv_py312.bat` 重建 venv 並啟動（會用 `python -m uvicorn`）。

4. **仍被擋時**  
   - 請 IT 將「專案目錄」或「放專案的磁碟」加入 Application Control / Device Guard 白名單，**或**  
   - 把專案搬到不受策略限制的磁碟/路徑（例如 D:\ 或公司允許的開發路徑），再重裝前端依賴、重建後端 venv。

---

## 對應關係速查

| 您看到的現象 | 可能起點 | 建議動作 |
|--------------|----------|----------|
| 前端：Cannot find module @rollup/rollup-win32-x64-msvc | ① + ② 原生 Rollup 被擋或沒裝好 | 用 reinstall_frontend.bat、確認 ROLLUP_SKIP_NATIVE=1、Node 20/22 |
| 後端：uvicorn 無法啟動 / 被阻擋 | ① + ② uvicorn.exe 被擋 | 用 recreate_venv_py312.bat（已改為 python -m uvicorn） |
| 視窗閃退或 '1.' is not recognized | ④ bat 編碼/編號 | 已改 [1][2][3] 與 chcp 65001，請用最新版 bat |
| Pydantic 型別錯誤 / Python 版本 | Python 3.14 與 Pydantic 不相容 | 用 Python 3.12 + recreate_venv_py312.bat |

總結：**從「Windows 安全策略阻擋原生執行檔／.node」開始**，導致前端與後端無法正常啟動；專案已盡量繞道與防呆，若環境策略不變，最終仍可能需要 IT 放行或改放專案路徑。
