"模組","子功能","Backend：API 方法+路徑（含 query/body 範例）、回傳 schema、錯誤碼","Backend：相關檔案路徑（router/crud/schemas/models/tests/migrations）","DB：資料表名稱、欄位摘要、索引、constraint、刪除策略","Frontend：頁面路由、元件檔案、表單欄位、驗證規則、操作流程","測試：有哪些測試（檔名）、覆蓋的功能點、如何執行","驗收方式：用什麼操作或 API 呼叫可驗收（最少 1 條）"
"人事","員工 CRUD 列表搜尋分頁","GET /api/employees?skip=0&limit=100&search=&reveal_sensitive=0。回傳 List[EmployeeRead]。","routers/employees.py; crud.py(list_employees, get_employee); schemas.py(EmployeeRead, EmployeeCreate, EmployeeUpdate); models.py(Employee); migrations 001,002,004","employees: id PK, name, birth_date, national_id, reg_address, live_address, live_same_as_reg, salary_type, salary_value, insured_salary_level, enroll_date, cancel_date, dependent_count, safety_pdf_path, contract_84_1_pdf_path, notes, created_at, updated_at。刪除 CASCADE dependents/documents/salary_profile/insurance_monthly_results/site_assignments","路由 / 。元件 EmployeeList.tsx。表單：搜尋框（姓名或身分證後四碼）。操作：載入列表→搜尋→點詳情/編輯。","無專用 E2E","GET /api/employees?limit=10 回傳陣列；或前端 / 可見清單。"
"人事","員工取得/新增/更新/刪除","GET /api/employees/{id}?reveal_sensitive=0。POST /api/employees body EmployeeCreate。PATCH /api/employees/{id} body EmployeeUpdate。DELETE /api/employees/{id} 204。404 員工不存在。","同上","同上","路由 /employees/new, /employees/:id, /employees/:id/edit。元件 EmployeeForm.tsx, EmployeeDetail.tsx。表單欄位：姓名、出生日、身分證、戶籍/居住地址、同戶籍、薪資類型/數值、投保級距、加退保日、眷屬數、備註。驗證：身分證 10 碼。","無","POST /api/employees 一筆後 GET /api/employees/{id} 回傳該筆。"
"人事","薪資設定 GET/PUT","GET /api/employees/{id}/salary-profile 回傳 SalaryProfileRead|null。PUT /api/employees/{id}/salary-profile body SalaryProfileUpdate。404 員工不存在。","routers/employees.py; crud.py(get_salary_profile, upsert_salary_profile); schemas.py(SalaryProfileRead, SalaryProfileUpdate); models.py(SalaryProfile); migrations 004","salary_profiles: id PK, employee_id UK FK, salary_type, monthly_base, daily_rate, hourly_rate, overtime_eligible, calculation_rules, created_at, updated_at。刪除：員工刪除 CASCADE。","前端無獨立薪資設定頁；API 供排班/會計用。","無","PUT /api/employees/1/salary-profile body {""salary_type"":""月薪"",""monthly_base"":30000} 回傳 SalaryProfileRead。"
"眷屬","眷屬 CRUD","GET /api/employees/{id}/dependents?reveal_sensitive=0。POST/PATCH/DELETE 對應路徑。body DependentCreate/DependentUpdate。404 員工或眷屬不存在。","routers/employees.py; crud.py(list_dependents_by_employee, create_dependent, update_dependent, delete_dependent, get_dependent); schemas.py(DependentBase, Create, Update, Read); models.py(Dependent); migrations 001,002","dependents: id PK, employee_id FK CASCADE, name, birth_date, national_id, relation, city, is_disabled, disability_level, notes, created_at, updated_at。索引 employee_id。","EmployeeForm 眷屬區塊：依眷屬數量限制卡片數；關係/縣市/身障等級。驗證身分證。","test_health_reduction 覆蓋眷屬減免；test_insurance_billing 帶眷屬試算。","POST /api/employees/1/dependents body {""name"":""測試"",""relation"":""子女""} 回傳 201；GET /api/employees/1/dependents 可見。"
"計費","試算與級距下拉","GET /api/insurance/brackets。GET /api/insurance/salary-to-level?salary=26400。POST /api/insurance/estimate body { employee_id?, insured_salary_level?, dependent_count?, year?, month? } 回傳 InsuranceEstimateResponse。","routers/insurance.py; crud.py(get_all_insurance_rules); schemas.py(InsuranceEstimateRequest, InsuranceEstimateResponse, SalaryBracketItem 等); services/insurance_calc.py, billing_days.py; models InsuranceMonthlyResult, InsuranceConfig; migrations 004","insurance_config: id PK, config_key UK, config_value, description, updated_at。insurance_monthly_results: id PK, employee_id FK, year_month, item_type, employee_amount, employer_amount, gov_amount, created_at。索引 employee_id, year_month, item_type。","員工詳情頁顯示當月試算；表單級距下拉 brackets、輸入薪資對級距 salaryToLevel。","test_billing_days.py(天數/健保比例/勞保等按天); test_health_reduction.py(身障/65歲減免); test_insurance_billing.py(estimate_insurance 整月/月中/退保/月底加保/跨月)。執行 cd backend && python run_tests.py。","POST /api/insurance/estimate body {""insured_salary_level"":26400,""year"":2025,""month"":1} 回傳含 labor_insurance/health_insurance。"
"計費","保險結果落表產生與查詢","POST /api/insurance/monthly-result/generate?year=&month=&overwrite= 回傳 { year, month, year_month, employees_processed }。GET /api/insurance/monthly-result?year_month=202501&employee_id= 回傳 List[InsuranceMonthlyResultRead]。","同上 crud list_insurance_monthly_results, upsert_insurance_monthly_result, delete_insurance_monthly_results_for_month","同上 insurance_monthly_results","前端未直接呼叫；會計/後台用。","無","POST generate?year=2025&month=1 後 GET monthly-result?year_month=202501 回傳列表。"
"級距表","列表與當月有效","GET /api/rate-tables?type= labor_insurance|health_insurance|occupational_accident|labor_pension。GET /api/rate-tables/effective?year=&month= 回傳 Dict[type, RateTableRead|null]。400 type 不合法。","routers/rate_tables.py; crud.py(list_rate_tables, get_effective_rate_table, get_rate_table_by_id, build_rules_from_rate_tables); schemas RateTableRead, RateItemRead; models RateTable, RateItem; migrations 003","rate_tables: id PK, type, version, effective_from, effective_to, total_rate, note。索引 type。rate_items: id PK, table_id FK CASCADE, level_name, salary_min, salary_max, insured_salary, employee_rate, employer_rate, gov_rate, fixed_amount_if_any。刪除 rate_table 時 items CASCADE。","路由 /rate-tables。元件 RateTables.tsx。選擇年月檢視有效表、篩選 type、列表所有版本。","無","GET /api/rate-tables/effective?year=2025&month=1 回傳各 type；前端上傳 JSON 匯入後列表出現新版本。"
"級距表","匯入 JSON/Excel/Word","POST /api/rate-tables/import body RateTableImportPayload 或 file .json/.xlsx/.docx。回傳 List[RateTableRead]。400 未提供或格式錯誤。","同上；rate_tables.py 內 _parse_excel_rate_tables, _parse_docx_rate_tables","同上","RateTables 上傳 file input、匯入後重新載入。","無","POST /api/rate-tables/import 帶 body.tables 或 file 回傳 200 含 RateTableRead 列表。"
"案場","案場列表（已驗證不可改）","GET /api/sites?page=1&page_size=20&load_assignments=&q=&payment_method=&is_841=&contract_active=。回傳 SiteListResponse(items, total, page, page_size)。422 參數錯誤。※ total/items SQL、分頁、q、contract_active 已驗證不可改。","routers/sites.py; crud.py(list_sites 已驗證不可改); schemas SiteRead, SiteListResponse; models Site; migrations 005,006","sites: id PK, name, client_name, address, contract_start, contract_end, monthly_amount, payment_method, receivable_day, notes, daily_required_count, shift_hours, is_84_1, night_shift_allowance, bear_labor_insurance, bear_health_insurance, has_group_or_occupational, rebate_type, rebate_value, created_at, updated_at。索引 name, client_name, contract_end, payment_method(006)。","無案場專用頁；API 就緒。","scripts/verify_sites_api.py 驗證 list_sites 分頁與過濾；README_SITES_VALIDATION.md。","GET /api/sites?page=1&page_size=20&q=關鍵字&contract_active=true 回傳 total 與 items；或執行 python backend/scripts/verify_sites_api.py。"
"案場","案場 CRUD 與指派 CRUD","GET/POST/PATCH/DELETE /api/sites、GET/POST/PATCH/DELETE /api/sites/{id}/assignments、GET /api/sites/by-employee/{id}/assignments。SiteCreate/SiteUpdate/SiteAssignmentCreate/SiteAssignmentUpdate。404 案場/員工/指派不存在；409 重複指派或期間重疊。","routers/sites.py; crud.py(get_site, create_site, update_site, delete_site, get_assignment, list_assignments_by_site, list_assignments_by_employee, check_assignment_period_overlap, create_assignment, update_assignment, delete_assignment, AssignmentPeriodOverlapError); schemas Site* SiteAssignment*; models Site, SiteEmployeeAssignment; migrations 005,006","site_employee_assignments: id PK, site_id FK CASCADE, employee_id FK CASCADE, effective_from, effective_to, notes, created_at。UK(site_id, employee_id)。索引 site_id, employee_id, effective_from, effective_to(006)。刪除案場或員工時指派 CASCADE。","無","無","POST /api/sites body SiteCreate 回傳 201；POST /api/sites/1/assignments body {""employee_id"":1} 回傳 201；重複同案場同員工 409。"
"報表","匯出 Excel","GET /api/reports/export/employees、/dependents、/monthly-burden?year=&month=、/personal-burden?year=&month=。回傳 Excel stream。Content-Disposition 用 ASCII 檔名。","routers/reports.py; crud list_employees, get_all_insurance_rules; services insurance_calc.estimate_insurance","僅讀 employees, dependents, insurance 規則；無報表專用表。","路由 /reports。元件 Reports.tsx。選年/月→三個按鈕公司負擔總表、員工個人負擔明細、眷屬明細。downloadReportExcel。","無","GET /api/reports/export/monthly-burden?year=2025&month=1 回傳 xlsx；前端報表頁下載。"
"檔案","上傳/列表/下載","GET /api/documents/employee/{id}。POST /api/documents/employee/{id}/upload form document_type(security_check|84_1) file PDF。GET /api/documents/{doc_id}/download。400 非 PDF 或超大小；404 員工或檔案不存在。","routers/documents.py; crud add_document, get_document, list_documents_by_employee; schemas DocumentRead; models EmployeeDocument","employee_documents: id PK, employee_id FK CASCADE, document_type, file_name, file_path, file_size, uploaded_at。索引 employee_id。","員工詳情頁：檔案列表、上傳選類型+PDF、10MB 提示、下載連結。","無","POST upload form-data document_type=security_check file=xxx.pdf 回傳 201；GET /api/documents/employee/1 可見；GET /api/documents/{id}/download 可下載。"
"規則與設定","健保減免規則與保險設定","GET /api/rules/health-reduction 回傳 List[dict]。GET /api/settings/insurance 回傳費率。PUT /api/settings/insurance body 部分 key 物件。400 不支援 key。","routers/rules.py, settings.py; rules/health_reduction.py; crud get_insurance_config, set_insurance_config, get_all_insurance_rules; config YAML","insurance_config 同上。","未直接呼叫。","test_health_reduction 覆蓋 apply_health_reduction。","GET /api/rules/health-reduction 回傳陣列；GET /api/settings/insurance 回傳費率物件。"
"啟動部署","一鍵啟動與單元測試","無 API；啟動.bat 檢查環境、安裝、啟動前後端、開瀏覽器。backend/run_tests.py 執行 pytest tests/ -v --tb=short。","main.py 註冊所有 router；backend 1_install.bat 2_start_backend.bat；run_tests.py","無","啟動器資料夾：一鍵啟動、僅前端/後端、安裝、開啟網頁。","pytest tests/ 見計費模組。","執行 啟動.bat 後 http://localhost:5173 與 http://localhost:8000/docs 可開；python run_tests.py 全部通過。"
