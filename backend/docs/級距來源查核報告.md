# 勞健保級距來源查核報告（僅查核，未改邏輯）

## 更正：YAML 最高投保級距

- **正確**：`insurance_rules.yaml` 最後一列為 `[ 603001, 999999, 603000 ]`，即薪資 603,001～999,999 對應**投保級距 603,000**（六十萬三千元）。
- 先前誤植為「最高投保級距 60,300」已更正為 **603,000**。

---

## 1) GET /api/insurance/brackets 目前實際回傳的級距（是否包含 7580）

**資料來源（程式路徑）**：  
`GET /api/insurance/brackets` → `routers/insurance.py` 的 `list_brackets()` → `crud.get_all_insurance_rules(db)` → `insurance_calc.get_brackets(rules)` → 讀取 **`rules["labor_insurance"]["brackets"]`**。  
在未從 DB 覆寫的狀況下，該值來自 **`config/insurance_rules.yaml`** 的 `labor_insurance.brackets`。

**回傳型別**：`list[SalaryBracketItem]`，每筆為 `{ level, low, high }`，其中 `level = b[2]`、`low = b[0]`、`high = b[1]`（YAML 每列 [下限, 上限, 投保級距]）。

**結論**：  
- **有 7580**。YAML 第 21 列為 `[ 6001, 7580, 7580 ]`，故 API 會回傳一筆 `level=7580, low=6001, high=7580`。  
- 目前回傳的「級距（level）」共 **99 筆**，依 YAML 從 1500 到 **603000**（最後一筆為 `level=603000, low=603001, high=999999`）。

**前 20 筆 level 陳列**（依 YAML 順序）：

| # | low     | high   | level（投保級距） |
|---|--------|--------|-------------------|
| 1 | 1      | 1500   | 1500              |
| 2 | 1501   | 3000   | 3000              |
| 3 | 3001   | 4500   | 4500              |
| 4 | 4501   | 6000   | 6000              |
| 5 | 6001   | **7580** | **7580**        |
| 6 | 7581   | 9000   | 9000              |
| 7 | 9001   | 10500  | 10500             |
| 8 | 10501  | 12000  | 12000             |
| 9 | 12001  | 13500  | 13500             |
|10 | 13501  | 15000  | 15000             |
|11 | 15001  | 16500  | 16500             |
|12 | 16501  | 18200  | 18200             |
|13 | 18201  | 19500  | 19500             |
|14 | 19501  | 21000  | 21000             |
|15 | 21001  | 22800  | 22800             |
|16 | 22801  | 24000  | 24000             |
|17 | 24001  | 25200  | 25200             |
|18 | 25201  | 26400  | 26400             |
|19 | 26401  | 27600  | 27600             |
|20 | 27601  | 28800  | 28800             |

最後一筆：`low=603001, high=999999, level=603000`。

---

## 2) Latest import 的 insurance_brackets 目前有哪些 insured_salary_level

**來源**：資料庫表 `insurance_bracket_imports`（最新一筆 `id`）+ `insurance_brackets`（該 `import_id` 的所有列）。

**取得方式（請在本機執行其一）**：

- **方式 A**：執行腳本  
  `backend/scripts/list_bracket_levels.py`  
  會輸出：最新 `import_id`、總筆數、前 15 筆、7400～12000 區間、以及全部 `insured_salary_level`。

- **方式 B**：直接查 SQLite（在 `backend` 目錄下）  
  ```text
  sqlite3 hr.db
  ```
  然後執行：
  ```sql
  SELECT id FROM insurance_bracket_imports ORDER BY id DESC LIMIT 1;
  -- 記下 id，假設為 N，再執行：
  SELECT insured_salary_level FROM insurance_brackets WHERE import_id = N ORDER BY insured_salary_level;
  ```

若您的 Excel 為 7500/8700/9900/11100 那套，預期會看到該套級距（例如含 7500、8700、9900、11100 等），且**不會**出現 7580（7580 為 YAML 舊級距）。

**此報告撰寫時未執行 DB 查詢**（本環境無法跑腳本），請您在本機執行上述腳本或 SQL 後，將「前 15 筆」與「含 7500 的那段」貼上，即可與第 1 點比對。

---

## 3) 比對差異與前端下拉選單資料來源

**目前兩邊差異**：

| 項目           | 下拉選單（級距列表）     | 試算金額                     |
|----------------|--------------------------|------------------------------|
| 資料來源       | `GET /api/insurance/brackets` | 最新匯入的 `insurance_brackets`（DB） |
| 後端邏輯       | `get_brackets(rules)`，rules 來自 YAML / insurance_config / rate_tables | `get_latest_bracket_import(db)` → `get_bracket_by_level(db, import_id, level)` |
| 是否含 7580    | 是（YAML 有 6001～7580） | 依您匯入的 Excel，若為 7500 那套則否 |
| 是否含 7500 那套 | 否（YAML 無 7500/8700/9900/11100） | 是（若 Excel 為該套） |

**前端下拉選單實際使用的 API 與程式位置**：

- **API**：`GET /api/insurance/brackets`（見 `frontend/src/api.ts`：`brackets: () => request<...>('/insurance/brackets')`）。
- **產生 options 的程式碼**：**`frontend/src/pages/EmployeeForm.tsx`**

  - 取得資料：第 45～48 行  
    ```ts
    useEffect(() => {
      insuranceApi.brackets().then(setBrackets).catch(() => [])
    }, [])
    ```
  - 渲染選單：第 261～272 行  
    ```ts
    <label className="label">加保投保薪資級距</label>
    <select
      className="input"
      value={form.insured_salary_level ?? ''}
      onChange={(e) => update('insured_salary_level', e.target.value ? Number(e.target.value) : '')}
    >
      <option value="">-- 請選擇級距 --</option>
      {brackets.map((b) => (
        <option key={b.level} value={b.level}>
          {b.level}（{b.low}～{b.high}）
        </option>
      ))}
    </select>
    ```

因此，**前端下拉選單的選項 100% 來自 `GET /api/insurance/brackets`**，而該 API 目前回傳的是 **rules 的 labor_insurance.brackets（預設為 YAML）**，**不是** DB 最新匯入的 `insurance_brackets`。

---

## 小結（供後續修正行為用）

- **1)** `GET /api/insurance/brackets` 目前回傳 YAML 的 99 筆級距，**包含 7580**，最高 level 為 **603,000**（不是 60,300）。
- **2)** Latest import 的 `insurance_brackets` 需在本機執行 `scripts/list_bracket_levels.py` 或上述 SQL 取得；若為 7500 那套，預期會有 7500、8700、9900、11100 等，且無 7580。
- **3)** 前端下拉選單只吃 **`GET /api/insurance/brackets`**，資料來自 **YAML（rules）**，與試算使用的 **DB 最新匯入** 不一致。  
若要「兩邊一致」，需改為：**下拉選單改以 DB 最新匯入的 insurance_brackets 為準**（例如新增 API 或讓現有 `/api/insurance/brackets` 改從 latest import 組出 level/low/high），試算維持同一份 latest import 的 insurance_brackets。
